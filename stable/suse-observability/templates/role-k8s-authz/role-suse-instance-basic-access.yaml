{{- define "stackstate.k8s.authorization.instance.base.role" -}}
metadata:
  name: {{ template "common.fullname.short" . }}-instance-basic-access
rules:
  - apiGroups:
      - instance.observability.cattle.io
    resources:
      - views
      - apitokens
      - systemnotifications
      - settings
      - stackpacks
      - metricbindings
    verbs:
      - get
  - apiGroups:
      - instance.observability.cattle.io
    resources:
      - visualizationsettings
    verbs:
      - update
  - apiGroups:
      - instance.observability.cattle.io
    resources:
      - componentactions
    verbs:
      - execute
  - apiGroups:
      - instance.observability.cattle.io
    resources:
      - favoriteviews
    verbs:
      - update
      - delete
      - create
{{- end -}}

{{- if and (index .Values "role-k8s-authz" "enabled") (eq .Values.stackstate.deployment.mode  "SelfHosted") -}}
{{- $commonClusterRole := fromYaml (include "common.role" .) -}}
{{- $stsK8sAuthzRole := fromYaml (include "stackstate.k8s.authorization.instance.base.role" .) -}}
{{- toYaml (merge $stsK8sAuthzRole $commonClusterRole) -}}
{{- end -}}
